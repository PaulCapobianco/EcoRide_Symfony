<section
  id="section-vehicules"
  class="settings-section card profile-card"
  data-requires="driver"
  {% if user.profilType == 'passenger' %}hidden{% endif %}
>
  <div class="card-body">
    <div class="card-title-row">
      <h2 class="card-title mb-0">Véhicules</h2>
      <div class="card-actions d-flex gap-2">
        <a href="{{ path('profile_vehicle_new') }}" class="btn btn-success btn-sm">Ajouter une voiture</a>
      </div>
    </div>

    {% if vehicules is empty %}
      <p class="text-muted mt-2 mb-0">
        Vous n'avez pas encore enregistré de véhicule.
      </p>
    {% else %}
      <div class="vehicle-list d-flex flex-column gap-3 mt-3">
        <div class="accordion" id="vehicleAccordion">
        {% for vehicule in vehicules %}
          {% set energie = vehicule.energie is defined ? vehicule.energie : null %}
          {% set energieLower = energie is not null ? energie|lower : '' %}
          {% set isEco = energieLower matches '/electriq/' %}
          {% set collapseId = 'vehicleCollapse' ~ vehicule.id %}

          <article class="vehicle-card card">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
              {% set marqueLabel = vehicule.marque.libelle ?? vehicule.marque %}
              <div class="vehicle-title fw-semibold {{ isEco ? 'text-success' : 'text-dark' }}">
                {{ marqueLabel }}
                {% if vehicule.modele %}
                  {{ ' ' ~ vehicule.modele }}
                {% endif %}
              </div>
              <button class="btn btn-outline-secondary btn-sm collapsed" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#{{ collapseId }}"
                      aria-expanded="false"
                      aria-controls="{{ collapseId }}">
                Détails
              </button>
            </div>
            <div id="{{ collapseId }}" class="collapse">
              <div class="card-body">
                <div class="vehicle-line">
                  <span class="vehicle-label">Marque / Modèle</span>
                  <span class="vehicle-value">
                    {{ marqueLabel }}
                    {% if vehicule.modele is defined and vehicule.modele %}
                      {{ vehicule.modele }}
                    {% endif %}
                  </span>
                </div>

                {% if vehicule.couleur is defined %}
                  <div class="vehicle-line">
                    <span class="vehicle-label">Couleur</span>
                    <span class="vehicle-value">
                      {{ vehicule.couleur ?? '—' }}
                    </span>
                  </div>
                {% endif %}

                {% if vehicule.immatriculation is defined %}
                  <div class="vehicle-line">
                    <span class="vehicle-label">Immatriculation</span>
                    <span class="vehicle-value">
                      {{ vehicule.immatriculation ?? '—' }}
                    </span>
                  </div>
                {% endif %}

                {% if energie is not null %}
                  <div class="vehicle-line">
                    <span class="vehicle-label">Énergie</span>
                    <span class="vehicle-value">
                      {{ energie }}
                      {% if isEco %}
                        <span class="badge bg-success ms-2">EcoRider</span>
                      {% endif %}
                    </span>
                  </div>
                {% endif %}

                {% if vehicule.datePremiereImmatriculation is defined and vehicule.datePremiereImmatriculation %}
                  <div class="vehicle-line">
                    <span class="vehicle-label">Date 1<sup>ère</sup> immatriculation</span>
                    <span class="vehicle-value">
                      {{ vehicule.datePremiereImmatriculation }}
                    </span>
                  </div>
                {% endif %}

                <div class="mt-3 d-flex justify-content-end gap-2">
                  <a
                    href="{{ path('profile_vehicle_edit', { id: vehicule.id }) }}"
                    class="btn btn-outline-secondary btn-sm"
                  >
                    Modifier
                  </a>

                  <form
                    method="post"
                    action="{{ path('profile_vehicle_delete', { id: vehicule.id }) }}"
                    onsubmit="return confirm('Supprimer ce véhicule ?');"
                    class="d-inline"
                  >
                    <input type="hidden" name="_token" value="{{ csrf_token('delete_vehicle_' ~ vehicule.id) }}">
                    <button class="btn btn-outline-danger btn-sm">Supprimer</button>
                  </form>
                </div>
              </div>
            </div>
          </article>
        {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
</section>
