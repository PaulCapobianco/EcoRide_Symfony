<section id="section-avis" class="card profile-card mb-3">
  <div class="card-body">
    <div class="card-title-row">
      <h2 class="card-title mb-0">Avis reçus</h2>
      <span class="text-muted small">Avis validés et note moyenne</span>
    </div>

    {% set avisPager = driver_avis_pagination ?? {
  'items': (driver_avis is defined and driver_avis is not null) ? driver_avis : [],
  'total': driver_avis is defined ? driver_avis|length : 0,
  'page': 1,
  'pages': 1
} %}
    {% if avisPager.total == 0 %}
      <p class="text-muted mb-0">Vous n'avez pas encore d'avis validés.</p>
    {% else %}
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="stat-card" style="min-width:120px;">
          <div class="stat-value">
            {% if rating_avg is not null %}
              {{ rating_avg|number_format(1, ',', ' ') }}
            {% else %}
              —
            {% endif %}
          </div>
          <div class="stat-label">
            note moyenne
            {% if rating_count is not null and rating_count > 0 %}
              <span class="text-muted small">({{ rating_count }} avis)</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Trajet</th>
              <th>Passager</th>
              <th>Note</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody>
            {% for avis in avisPager.items %}
              {% set ride = avis.covoiturage %}
              {% set passenger = avis.utilisateur %}
              <tr>
                <td class="text-break">
                  <div class="fw-semibold">{{ ride.lieuDepart }} → {{ ride.lieuArrivee }}</div>
                  <div class="text-muted small">{{ ride.dateDepart|date('d/m/Y') }} à {{ ride.heureDepart|date('H:i') }}</div>
                </td>
                <td class="text-muted small text-break">
                  {{ passenger.prenom ?? '' }} {{ passenger.nom ?? '' }}<br>
                  {{ passenger.email ?? '' }}
                </td>
                <td class="fw-semibold text-center">{{ avis.note is not null ? avis.note : '—' }}</td>
                <td class="text-break small">{{ avis.commentaire ?: '—' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if avisPager.pages > 1 %}
        {% set prev = avisPager.page > 1 ? avisPager.page - 1 : 1 %}
        {% set next = avisPager.page < avisPager.pages ? avisPager.page + 1 : avisPager.pages %}
        <nav class="mt-3" aria-label="Pagination avis">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item {{ avisPager.page == 1 ? 'disabled' }}">
              <a class="page-link" href="{{ path('profile', { avis_page: prev }) }}#section-avis">Précédent</a>
            </li>
            {% for pageNumber in 1..avisPager.pages %}
              <li class="page-item {{ pageNumber == avisPager.page ? 'active' }}">
                <a class="page-link" href="{{ path('profile', { avis_page: pageNumber }) }}#section-avis">{{ pageNumber }}</a>
              </li>
            {% endfor %}
            <li class="page-item {{ avisPager.page == avisPager.pages ? 'disabled' }}">
              <a class="page-link" href="{{ path('profile', { avis_page: next }) }}#section-avis">Suivant</a>
            </li>
          </ul>
        </nav>
      {% endif %}
    {% endif %}
  </div>
</section>
