{% extends 'base.html.twig' %}

{% block title %}EcoRide — Mes trajets{% endblock %}
{% block page_class %}page-profile-rides{% endblock %}

{% block body %}
<section class="layout-container py-4">

  <header class="mb-4">
    <h1 class="h3 mb-1">Mes trajets</h1>
    <p class="text-muted mb-0">
      Consultez vos trajets en cours, publiez-en de nouveaux ou basculez sur l'historique pour retrouver les trajets terminés et annulés.
    </p>
  </header>

  {% set current_tab = active_tab ?? 'current' %}
  {% set show_history = current_tab == 'history' %}
  {% set driverPager = driver_pagination %}
  {% set passengerPager = passenger_pagination %}

  <div class="d-flex flex-wrap gap-2 align-items-center mb-4">
    <div class="btn-group" role="group" aria-label="Filtrer les trajets">
      <a href="{{ path('profile_rides', { tab: 'current', driver_page: 1, passenger_page: 1 }) }}"
         class="btn btn-sm {{ show_history ? 'btn-outline-secondary' : 'btn-success' }}">
        Trajets actifs
      </a>
      <a href="{{ path('profile_rides', { tab: 'history', driver_page: 1, passenger_page: 1 }) }}"
         class="btn btn-sm {{ show_history ? 'btn-success' : 'btn-outline-secondary' }}">
        Historique
      </a>
    </div>
    {% if show_history %}
      <span class="text-muted small">Trajets terminés ou annulés sur les 2 colonnes ci-dessous.</span>
    {% else %}
      <span class="text-muted small">Afficher vos trajets à venir ou en cours.</span>
    {% endif %}
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0">
              {{ show_history ? 'Historique conducteur' : 'Mes trajets en tant que conducteur' }}
            </h2>

            {% if not show_history and app.user and app.user.profilType in ['driver', 'both'] %}
              <a href="{{ path('covoiturage_publish') }}" class="btn btn-sm btn-success">
                Publier un trajet
              </a>
            {% endif %}
          </div>

          {% if driverPager.total > 0 %}
            <div class="vstack gap-3">
              {% for ride in driverPager.items %}
                {% set remaining = ride.nbPlace ?? 0 %}
                {% set status = ride.statut ?? 'OUVERT' %}
                {% if status in ['OUVERT', ''] and remaining <= 0 %}
                  {% set status = 'COMPLET' %}
                {% endif %}
                {% set badgeClass =
                  status == 'OUVERT' ? 'bg-success' :
                  (status == 'COMPLET' ? 'bg-secondary' :
                  (status == 'ANNULE' ? 'bg-danger' :
                  (status == 'EN_COURS' ? 'bg-primary' :
                  (status == 'TERMINE' ? 'bg-info text-dark' : 'bg-outline-secondary'))))
                %}

                <article class="border rounded-3 p-3">
                  <header class="mb-2">
                    <h3 class="h6 mb-0">
                      {{ ride.lieuDepart }} → {{ ride.lieuArrivee }}
                    </h3>
                  </header>
                  <div class="d-flex justify-content-between flex-wrap gap-2">
                    <div>
                      <div class="text-muted small">
                        Départ le
                        {{ ride.dateDepart|date('d/m/Y') }}
                        à
                        {{ ride.heureDepart|date('H:i') }}
                      </div>
                      <div class="text-muted small">
                        {{ ride.nbPlace }} place(s) ·
                        {{ ride.prixPersonne }} crédits / personne
                      </div>
                    </div>
                    <div class="text-end">
                      <span class="badge {{ badgeClass }}">
                        {{ status|upper }}
                      </span>
                      <div class="mt-2 d-flex flex-wrap gap-1 justify-content-end">
                        <a href="{{ path('covoiturage_detail', { id: ride.id }) }}"
                           class="btn btn-sm btn-outline-secondary">
                          Détails
                        </a>

                        {% if not show_history %}
                          {% if status not in ['EN_COURS', 'TERMINE', 'ANNULE'] %}
                            <a href="{{ path('covoiturage_edit', { id: ride.id }) }}"
                               class="btn btn-sm btn-primary">
                              Modifier
                            </a>
                          {% endif %}

                          {% if status in ['OUVERT', 'COMPLET'] %}
                            <form method="post"
                                  action="{{ path('covoiturage_start', { id: ride.id }) }}"
                                  class="d-inline">
                              <input type="hidden" name="_token" value="{{ csrf_token('start_ride_' ~ ride.id) }}">
                              <button class="btn btn-sm btn-outline-primary">
                                Démarrer
                              </button>
                            </form>
                          {% elseif status == 'EN_COURS' %}
                            <form method="post"
                                  action="{{ path('covoiturage_finish', { id: ride.id }) }}"
                                  class="d-inline">
                              <input type="hidden" name="_token" value="{{ csrf_token('finish_ride_' ~ ride.id) }}">
                              <button class="btn btn-sm btn-outline-success">
                                Arrivée à destination
                              </button>
                            </form>
                          {% endif %}

                          {% if status != 'ANNULE' %}
                            <form method="post"
                                  action="{{ path('covoiturage_cancel_driver', { id: ride.id }) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('Annuler ce trajet ? Tous les passagers seront remboursés et informés par e-mail.');">
                              <input type="hidden" name="_token"
                                     value="{{ csrf_token('cancel_ride_' ~ ride.id) }}">
                              <button class="btn btn-sm btn-outline-danger">
                                Annuler
                              </button>
                            </form>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </article>
              {% endfor %}
            </div>

            {% if driverPager.pages > 1 %}
              {% set driverPrev = driverPager.page > 1 ? driverPager.page - 1 : 1 %}
              {% set driverNext = driverPager.page < driverPager.pages ? driverPager.page + 1 : driverPager.pages %}
              <nav class="mt-3" aria-label="Pagination trajets conducteur">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item {{ driverPager.page == 1 ? 'disabled' }}">
                    <a class="page-link"
                       href="{{ path('profile_rides', { tab: show_history ? 'history' : 'current', driver_page: driverPrev, passenger_page: passengerPager.page }) }}">
                      Précédent
                    </a>
                  </li>
                  {% for page in 1..driverPager.pages %}
                    <li class="page-item {{ page == driverPager.page ? 'active' }}">
                      <a class="page-link"
                         href="{{ path('profile_rides', { tab: show_history ? 'history' : 'current', driver_page: page, passenger_page: passengerPager.page }) }}">
                        {{ page }}
                      </a>
                    </li>
                  {% endfor %}
                  <li class="page-item {{ driverPager.page == driverPager.pages ? 'disabled' }}">
                    <a class="page-link"
                       href="{{ path('profile_rides', { tab: show_history ? 'history' : 'current', driver_page: driverNext, passenger_page: passengerPager.page }) }}">
                      Suivant
                    </a>
                  </li>
                </ul>
              </nav>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">
              {% if show_history %}
                Aucun trajet historique en tant que conducteur.
              {% else %}
                Vous n’avez encore publié aucun trajet comme conducteur.
              {% endif %}
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h5 mb-3">
            {{ show_history ? 'Historique passager' : 'Mes trajets en tant que passager' }}
          </h2>

          {% if passengerPager.total > 0 %}
            <div class="vstack gap-3">
              {% for participation in passengerPager.items %}
                {% set ride = participation.covoiturage %}
                {% if ride %}
                  {% set remaining = ride.nbPlace ?? 0 %}
                  {% set status = ride.statut ?? 'OUVERT' %}
                  {% if status in ['OUVERT', ''] and remaining <= 0 %}
                    {% set status = 'COMPLET' %}
                  {% endif %}
                  {% set passengerBadge =
                    status == 'OUVERT' ? 'bg-success' :
                    (status == 'COMPLET' ? 'bg-secondary' :
                    (status == 'ANNULE' ? 'bg-danger' :
                    (status == 'EN_COURS' ? 'bg-primary' :
                    (status == 'TERMINE' ? 'bg-info text-dark' : 'bg-outline-secondary'))))
                  %}
                  {% set confirmation = participation.confirmationStatus ?? 'PENDING' %}
                  {% set confirmationLabel =
                    confirmation == 'VALIDATED' ? 'Validé' :
                    (confirmation == 'REPORTED' ? 'Signalé' :
                    (confirmation == 'REFUSED' ? 'Refusé' :
                    (confirmation == 'AWAITING_VALIDATION' ? 'En validation' : 'En attente')))
                  %}

                  <article class="border rounded-3 p-3">
                    <header class="mb-2">
                      <h3 class="h6 mb-0">
                        {{ ride.lieuDepart }} → {{ ride.lieuArrivee }}
                      </h3>
                    </header>
                    <div class="d-flex justify-content-between flex-wrap gap-2">
                      <div>
                        <div class="text-muted small">
                          Départ le
                          {{ ride.dateDepart|date('d/m/Y') }}
                          à
                          {{ ride.heureDepart|date('H:i') }}
                        </div>
                        <div class="text-muted small">
                          {{ participation.nbPlaces }} place(s) réservée(s) ·
                          {{ ride.prixPersonne }} crédits / personne
                        </div>
                        {% if status == 'TERMINE' %}
                          <div class="text-muted small">
                            Validation : {{ confirmationLabel }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="text-end">
                        <span class="badge {{ passengerBadge }}">
                          {{ status|upper }}
                        </span>
                        <div class="mt-2 d-flex flex-wrap gap-1 justify-content-end">
                          <a href="{{ path('covoiturage_detail', { id: ride.id }) }}"
                             class="btn btn-sm btn-outline-secondary">
                            Détails
                          </a>

                          {% if not show_history and status in ['OUVERT', 'COMPLET'] %}
                            <form
                              method="post"
                              action="{{ path('covoiturage_annuler_participation', { id: participation.id }) }}"
                              class="d-inline"
                              onsubmit="return confirm('Annuler votre participation à ce covoiturage ? Les crédits vous seront recrédités si l’annulation est possible.');"
                            >
                              <input type="hidden" name="_token"
                                     value="{{ csrf_token('annuler_participation_' ~ participation.id) }}">
                              <button class="btn btn-sm btn-outline-danger">
                                Annuler ma participation
                              </button>
                            </form>
                          {% endif %}

                          {% if status == 'TERMINE' and confirmation in ['PENDING', 'AWAITING_VALIDATION'] %}
                            <a href="{{ path('profile_feedback') }}"
                               class="btn btn-sm btn-outline-success">
                              Laisser un avis
                            </a>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </article>
                {% endif %}
              {% endfor %}
            </div>

            {% if passengerPager.pages > 1 %}
              {% set passengerPrev = passengerPager.page > 1 ? passengerPager.page - 1 : 1 %}
              {% set passengerNext = passengerPager.page < passengerPager.pages ? passengerPager.page + 1 : passengerPager.pages %}
              <nav class="mt-3" aria-label="Pagination trajets passager">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item {{ passengerPager.page == 1 ? 'disabled' }}">
                    <a class="page-link"
                       href="{{ path('profile_rides', { tab: show_history ? 'history' : 'current', driver_page: driverPager.page, passenger_page: passengerPrev }) }}">
                      Précédent
                    </a>
                  </li>
                  {% for page in 1..passengerPager.pages %}
                    <li class="page-item {{ page == passengerPager.page ? 'active' }}">
                      <a class="page-link"
                         href="{{ path('profile_rides', { tab: show_history ? 'history' : 'current', driver_page: driverPager.page, passenger_page: page }) }}">
                        {{ page }}
                      </a>
                    </li>
                  {% endfor %}
                  <li class="page-item {{ passengerPager.page == passengerPager.pages ? 'disabled' }}">
                    <a class="page-link"
                       href="{{ path('profile_rides', { tab: show_history ? 'history' : 'current', driver_page: driverPager.page, passenger_page: passengerNext }) }}">
                      Suivant
                    </a>
                  </li>
                </ul>
              </nav>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">
              {% if show_history %}
                Aucun trajet historique en tant que passager.
              {% else %}
                Vous n’avez participé à aucun trajet pour le moment.
              {% endif %}
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
