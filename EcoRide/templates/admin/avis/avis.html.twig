{% extends 'base.html.twig' %}

{% block title %}EcoRide — Avis à valider{% endblock %}
{% block page_class %}page-admin-avis{% endblock %}

{% block body %}
{% set pending_page = pending_page ?? 1 %}
{% set pending_pages = pending_pages ?? 1 %}
{% set validated_page = validated_page ?? 1 %}
{% set validated_pages = validated_pages ?? 1 %}
{% set refused_page = refused_page ?? 1 %}
{% set refused_pages = refused_pages ?? 1 %}
{% set query_params = app.request.query.all|default({}) %}
<section class="layout-container py-5">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h4 mb-1">Avis à valider</h1>
      <p class="text-muted mb-0">
        Traitez les signalements passagers et créditez le chauffeur si tout est conforme.
      </p>
    </div>
    <a href="{{ path('admin_incidents') }}" class="btn btn-outline-primary btn-sm">
      Covoiturages signalés
    </a>
  </header>

  {% if pending_avis is not empty %}
    <div class="vstack gap-3">
      {% for avis in pending_avis %}
        {% set ride = avis.covoiturage %}
        {% set passenger = avis.utilisateur %}
        <article class="border rounded-3 p-3">
          <div class="d-flex justify-content-between flex-wrap gap-2">
            <div class="flex-grow-1">
              <div class="fw-semibold">
                {{ ride.lieuDepart }} → {{ ride.lieuArrivee }}
                <span class="text-muted">· {{ ride.dateDepart|date('d/m/Y') }} à {{ ride.heureDepart|date('H:i') }}</span>
              </div>
              <div class="text-muted small text-break">
                Passager : {{ passenger.prenom ?? '' }} {{ passenger.nom ?? '' }} ({{ passenger.email ?? 'email inconnu' }})
              </div>
              <div class="text-muted small">
                Note : {{ avis.note is not null ? avis.note : '—' }}
              </div>
              {% if avis.commentaire %}
                <div class="mt-2">
                  <div class="text-muted small">Commentaire :</div>
                  <div class="border rounded p-2 bg-light text-break" style="word-break: break-word;">
                    {{ avis.commentaire }}
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
              <form method="post" action="{{ path('admin_avis_valider', { id: avis.id }) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('valider_avis_' ~ avis.id) }}">
                <button class="btn btn-sm btn-success">Valider & créditer</button>
              </form>
              <form method="post" action="{{ path('admin_avis_refuser', { id: avis.id }) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('refuser_avis_' ~ avis.id) }}">
                <button class="btn btn-sm btn-outline-danger">Refuser</button>
              </form>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="border rounded-3 p-4 text-center bg-light">
      <div class="fs-4 mb-2">✔️</div>
      <p class="mb-1 fw-semibold">Aucun avis en attente</p>
      <p class="text-muted mb-0">Revenez plus tard pour traiter les prochains signalements.</p>
    </div>
  {% endif %}

  {% if pending_pages > 1 %}
    <nav class="mt-3">
      <ul class="pagination pagination-sm mb-0 justify-content-center">
        {% set prev = pending_page - 1 %}
        {% set next = pending_page + 1 %}
        {% set prevParams = query_params|merge({
          'pending_page': prev < 1 ? 1 : prev,
          'validated_page': validated_page,
          'refused_page': refused_page
        }) %}
        {% set nextParams = query_params|merge({
          'pending_page': next > pending_pages ? pending_pages : next,
          'validated_page': validated_page,
          'refused_page': refused_page
        }) %}
        <li class="page-item {{ prev < 1 ? 'disabled' : '' }}">
          <a class="page-link" href="{{ path('admin_avis_index', prevParams) }}">Précédent</a>
        </li>
        {% for page in 1..pending_pages %}
          {% set params = query_params|merge({
            'pending_page': page,
            'validated_page': validated_page,
            'refused_page': refused_page
          }) %}
          <li class="page-item {{ page == pending_page ? 'active' : '' }}">
            <a class="page-link" href="{{ path('admin_avis_index', params) }}">{{ page }}</a>
          </li>
        {% endfor %}
        <li class="page-item {{ next > pending_pages ? 'disabled' : '' }}">
          <a class="page-link" href="{{ path('admin_avis_index', nextParams) }}">Suivant</a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <hr class="my-4">

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <h2 class="h5 mb-3">Avis validés</h2>
      {% if validated_avis is empty %}
        <p class="text-muted small mb-0">Aucun avis validé pour l’instant.</p>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Trajet</th>
                <th>Passager</th>
                <th>Note</th>
                <th>Commentaire</th>
              </tr>
            </thead>
            <tbody>
              {% for avis in validated_avis %}
                {% set ride = avis.covoiturage %}
                {% set passenger = avis.utilisateur %}
                <tr>
                  <td class="text-break">
                    <div class="fw-semibold">{{ ride.lieuDepart }} → {{ ride.lieuArrivee }}</div>
                    <div class="text-muted small">{{ ride.dateDepart|date('d/m/Y') }} à {{ ride.heureDepart|date('H:i') }}</div>
                  </td>
                  <td class="text-muted small text-break">
                    {{ passenger.prenom ?? '' }} {{ passenger.nom ?? '' }}<br>
                    {{ passenger.email ?? '' }}
                  </td>
                  <td class="fw-semibold text-center">{{ avis.note is not null ? avis.note : '—' }}</td>
                  <td class="text-break small">{{ avis.commentaire ?: '—' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if validated_pages > 1 %}
          <nav class="mt-2">
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              {% set prev = validated_page - 1 %}
              {% set next = validated_page + 1 %}
              {% set prevParams = query_params|merge({
                'pending_page': pending_page,
                'validated_page': prev < 1 ? 1 : prev,
                'refused_page': refused_page
              }) %}
              {% set nextParams = query_params|merge({
                'pending_page': pending_page,
                'validated_page': next > validated_pages ? validated_pages : next,
                'refused_page': refused_page
              }) %}
              <li class="page-item {{ prev < 1 ? 'disabled' : '' }}">
                <a class="page-link" href="{{ path('admin_avis_index', prevParams) }}">Précédent</a>
              </li>
              {% for page in 1..validated_pages %}
                {% set params = query_params|merge({
                  'pending_page': pending_page,
                  'validated_page': page,
                  'refused_page': refused_page
                }) %}
                <li class="page-item {{ page == validated_page ? 'active' : '' }}">
                  <a class="page-link" href="{{ path('admin_avis_index', params) }}">{{ page }}</a>
                </li>
              {% endfor %}
              <li class="page-item {{ next > validated_pages ? 'disabled' : '' }}">
                <a class="page-link" href="{{ path('admin_avis_index', nextParams) }}">Suivant</a>
              </li>
            </ul>
          </nav>
        {% endif %}
      {% endif %}
    </div>

    <div class="col-12 col-lg-6">
      <h2 class="h5 mb-3">Avis refusés</h2>
      {% if refused_avis is empty %}
        <p class="text-muted small mb-0">Aucun avis refusé.</p>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Trajet</th>
                <th>Passager</th>
                <th>Note</th>
                <th>Commentaire</th>
              </tr>
            </thead>
            <tbody>
              {% for avis in refused_avis %}
                {% set ride = avis.covoiturage %}
                {% set passenger = avis.utilisateur %}
                <tr>
                  <td class="text-break">
                    <div class="fw-semibold">{{ ride.lieuDepart }} → {{ ride.lieuArrivee }}</div>
                    <div class="text-muted small">{{ ride.dateDepart|date('d/m/Y') }} à {{ ride.heureDepart|date('H:i') }}</div>
                  </td>
                  <td class="text-muted small text-break">
                    {{ passenger.prenom ?? '' }} {{ passenger.nom ?? '' }}<br>
                    {{ passenger.email ?? '' }}
                  </td>
                  <td class="fw-semibold text-center">{{ avis.note is not null ? avis.note : '—' }}</td>
                  <td class="text-break small">{{ avis.commentaire ?: '—' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if refused_pages > 1 %}
          <nav class="mt-2">
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              {% set prev = refused_page - 1 %}
              {% set next = refused_page + 1 %}
              {% set prevParams = query_params|merge({
                'pending_page': pending_page,
                'validated_page': validated_page,
                'refused_page': prev < 1 ? 1 : prev
              }) %}
              {% set nextParams = query_params|merge({
                'pending_page': pending_page,
                'validated_page': validated_page,
                'refused_page': next > refused_pages ? refused_pages : next
              }) %}
              <li class="page-item {{ prev < 1 ? 'disabled' : '' }}">
                <a class="page-link" href="{{ path('admin_avis_index', prevParams) }}">Précédent</a>
              </li>
              {% for page in 1..refused_pages %}
                {% set params = query_params|merge({
                  'pending_page': pending_page,
                  'validated_page': validated_page,
                  'refused_page': page
                }) %}
                <li class="page-item {{ page == refused_page ? 'active' : '' }}">
                  <a class="page-link" href="{{ path('admin_avis_index', params) }}">{{ page }}</a>
                </li>
              {% endfor %}
              <li class="page-item {{ next > refused_pages ? 'disabled' : '' }}">
                <a class="page-link" href="{{ path('admin_avis_index', nextParams) }}">Suivant</a>
              </li>
            </ul>
          </nav>
        {% endif %}
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
