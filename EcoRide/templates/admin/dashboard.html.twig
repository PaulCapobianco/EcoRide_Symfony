{% extends 'base.html.twig' %}

{% block title %}EcoRide — Espace administrateur{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ asset('styles/admin-dashboard.css') }}">
{% endblock %}

{% block body %}
<section class="layout-container py-4">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h4 mb-1">Espace administrateur</h1>
      <p class="text-muted mb-0">Créer des comptes employés, suivre l’activité et suspendre des comptes.</p>
    </div>
  </header>


  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Créer un employé</h2>
          <form method="post" action="{{ path('admin_dashboard') }}" class="vstack gap-2" data-turbo="false">
            <div class="row g-2">
              <div class="col-6">
                <input class="form-control" type="text" name="firstname" placeholder="Prénom" required>
              </div>
              <div class="col-6">
                <input class="form-control" type="text" name="lastname" placeholder="Nom" required>
              </div>
            </div>
            <input class="form-control" type="email" name="email" placeholder="Email" autocomplete="off" required>
            <input class="form-control" type="password" name="password" placeholder="Mot de passe" autocomplete="new-password" required>
            <button class="btn btn-success btn-sm mt-2" type="submit">Créer</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Total crédits plateforme</h2>
          <div class="display-6 text-success">{{ total_credits ?? 0 }} crédits</div>
        </div>
      </div>
    </div>
  </div>

<div
  class="row g-4 mb-4"
  data-controller="admin-dashboard"
  data-admin-dashboard-rides-value='{{ rides_per_day|json_encode|e('html_attr') }}'
  data-admin-dashboard-gains-value='{{ gains_per_day|json_encode|e('html_attr') }}'
>
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h6 mb-3">Covoiturages par jour</h2>
        <canvas id="chartRides"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Crédits gagnés par jour</h2>
          <canvas id="chartGains"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h2 class="h6 mb-3">Comptes</h2>
      <div class="table-responsive">
        <table class="table align-middle admin-users-table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Email</th>
              <th>Rôle</th>
              <th>Statut</th>
              <th class="credit-col">Crédits</th>
              <th class="actions-cell">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td>{{ user.prenom }} {{ user.nom }}</td>
                <td>{{ user.email }}</td>
                <td>
                  {% set code = user.role ? user.role.libelle : null %}
                  {% if code == 'ROLE_ADMIN' %}
                    Administrateur
                  {% elseif code == 'ROLE_EMPLOYE' %}
                    Employé
                  {% elseif code == 'ROLE_USER' %}
                    Utilisateur
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if user.active %}
                    <span class="badge bg-success">Actif</span>
                  {% else %}
                    <span class="badge bg-danger">Suspendu</span>
                  {% endif %}
                </td>
                <td class="credit-col">
                  <div class="fw-semibold text-nowrap">{{ user.credit }} crédits</div>
                  {% if app.user and app.user.id != user.id %}
                    <form
                      id="credit-form-{{ user.id }}"
                      method="post"
                      action="{{ path('admin_user_credit', { id: user.id }) }}"
                      class="credit-form mt-2"
                    >
                      <input type="hidden" name="_token" value="{{ csrf_token('credit_user_' ~ user.id) }}">
                      <div class="input-group input-group-sm">
                        <input
                          type="number"
                          name="amount"
                          min="1"
                          class="form-control"
                          placeholder="Montant"
                          required
                        >
                        <span class="input-group-text text-success">
                          <i class="bi bi-coin" aria-hidden="true"></i>
                        </span>
                      </div>
                      <button class="btn btn-sm btn-outline-success" type="submit">
                        Ajouter
                      </button>
                    </form>
                  {% else %}
                    <span class="text-muted small">Votre compte</span>
                  {% endif %}
                </td>
                <td class="actions-cell">
                  {% if app.user and app.user.id == user.id %}
                    <span class="text-muted small">—</span>
                  {% else %}
                    <form method="post" action="{{ path('admin_user_toggle', { id: user.id }) }}">
                      <input type="hidden" name="_token" value="{{ csrf_token('toggle_user_' ~ user.id) }}">
                      <button class="btn btn-sm {{ user.active ? 'btn-outline-danger' : 'btn-outline-success' }}">
                        {{ user.active ? 'Suspendre' : 'Réactiver' }}
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if (total_pages ?? 1) > 1 %}
        <nav class="mt-3">
          <ul class="pagination pagination-sm mb-0 justify-content-center">
            {% set prev = (current_page ?? 1) - 1 %}
            {% set next = (current_page ?? 1) + 1 %}
            <li class="page-item {{ prev < 1 ? 'disabled' : '' }}">
              <a class="page-link" href="{{ path('admin_dashboard', { page: prev < 1 ? 1 : prev }) }}">Précédent</a>
            </li>
            {% for page in 1..(total_pages ?? 1) %}
              <li class="page-item {{ page == (current_page ?? 1) ? 'active' : '' }}">
                <a class="page-link" href="{{ path('admin_dashboard', { page: page }) }}">{{ page }}</a>
              </li>
            {% endfor %}
            <li class="page-item {{ next > (total_pages ?? 1) ? 'disabled' : '' }}">
              <a class="page-link" href="{{ path('admin_dashboard', { page: next > (total_pages ?? 1) ? (total_pages ?? 1) : next }) }}">Suivant</a>
            </li>
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
